name: "Generate Changelog"

on:
  release:
    types: [published]  # Trigger on release publication
  workflow_dispatch:      # Allows manual trigger of this workflow

permissions:
  contents: write

jobs:
  regenerateChangelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history to access all tags for complete changelog generation

      - name: Install git-chglog
        run: |
          curl -o git-chglog -L https://github.com/git-chglog/git-chglog/releases/download/0.9.1/git-chglog_linux_amd64
          chmod +x git-chglog

      - name: Remove Existing CHANGELOG.md
        run: |
          rm -f CHANGELOG.md  # Remove the existing changelog to allow complete regeneration

      - name: Generate New Full CHANGELOG.md
        run: |
          ./git-chglog -o CHANGELOG.md  # Generate the entire changelog with all release history
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Required by git-chglog to access repository info

      - name: Clean Up git-chglog
        run: |
          rm git-chglog

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Regenerate full CHANGELOG from all tags"
          file_pattern: CHANGELOG.md
          branch: regenerate-changelog-${{ github.run_id }}  # Unique branch for each run

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: "Regenerate full CHANGELOG"
          title: "Regenerate Full Changelog"
          body: "This PR regenerates the entire CHANGELOG to include all releases."
          branch: regenerate-changelog-${{ github.run_id }}  # Match the branch from the previous step
          base: main  # Target branch for PR
          delete-branch: true  # Automatically delete branch after merge
